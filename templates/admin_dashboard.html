{% extends 'base.html' %}

{% block title %}管理面板{% endblock %}

{% block head %}
<style>
    .dashboard-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
    }
    
    .dashboard-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .dashboard-title {
        margin-bottom: 20px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-label {
        display: block;
        margin-bottom: 5px;
        color: #555;
    }
    
    .form-input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .form-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }
    
    .btn {
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-primary {
        background: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0056b3;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn-danger:hover {
        background: #c82333;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-success:hover {
        background: #218838;
    }
    
    .categories-list {
        margin-top: 20px;
    }
    
    .category-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #eee;
    }
    
    .category-item:last-child {
        border-bottom: none;
    }
    
    .category-info {
        flex: 1;
    }
    
    .category-name {
        font-weight: bold;
        color: #333;
    }
    
    .category-path {
        font-size: 12px;
        color: #666;
        margin-top: 2px;
    }
    
    .category-actions {
        display: flex;
        gap: 10px;
    }
    
    .upload-form {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
    }
    
    .file-input-wrapper input[type="file"] {
        font-size: 100px;
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        cursor: pointer;
    }
    
    .file-input-label {
        display: inline-block;
        padding: 10px 15px;
        background: #6c757d;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    
    .file-input-label:hover {
        background: #5a6268;
    }
    
    .file-name {
        margin-top: 5px;
        font-size: 14px;
        color: #666;
    }
    
    .status-message {
        padding: 10px;
        border-radius: 4px;
        margin-top: 15px;
        text-align: center;
        display: none;
    }
    
    .status-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .progress-container {
        width: 100%;
        background: #f3f3f3;
        border-radius: 4px;
        margin-top: 10px;
        display: none;
    }
    
    .progress-bar {
        height: 20px;
        background: #007bff;
        border-radius: 4px;
        width: 0%;
        transition: width 0.3s ease;
    }
    
    @media (max-width: 768px) {
        .dashboard-container {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<h2 class="section-title"><i class="fas fa-tachometer-alt"></i> 管理面板</h2>

<div class="dashboard-container">
    <!-- 分类管理 -->
    <div class="dashboard-card">
        <h3 class="dashboard-title"><i class="fas fa-folder"></i> 分类管理</h3>
        
        <!-- 添加分类表单 -->
        <form id="add-category-form" class="upload-form">
            <div class="form-group">
                <label class="form-label" for="category-name">分类名称</label>
                <input type="text" id="category-name" class="form-input" required>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="category-path">文件夹路径</label>
                <input type="text" id="category-path" class="form-input" required>
            </div>
            
            <button type="submit" class="btn btn-primary">添加分类</button>
        </form>
        
        <div id="category-status" class="status-message"></div>
        
        <!-- 分类列表 -->
        <div class="categories-list">
            <h4>现有分类</h4>
            {% for category in categories %}
            <div class="category-item">
                <div class="category-info">
                    <div class="category-name">{{ category[1] }}</div>
                    <div class="category-path">{{ category[1] }}</div>
                </div>
                <div class="category-actions">
                    <button class="btn btn-success scan-btn" data-id="{{ category[0] }}">扫描文件夹</button>
                    {% if category[1] != '默认分类' %}
                    <button class="btn btn-danger delete-btn" data-id="{{ category[0] }}" data-name="{{ category[1] }}">删除</button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- 图片上传 -->
    <div class="dashboard-card">
        <h3 class="dashboard-title"><i class="fas fa-upload"></i> 图片上传</h3>
        
        <form id="upload-form" class="upload-form" enctype="multipart/form-data">
            <div class="form-group">
                <label class="form-label" for="upload-category">选择分类</label>
                <select id="upload-category" class="form-input" required>
                    {% for category in categories %}
                    <option value="{{ category[0] }}">{{ category[1] }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">选择图片</label>
                <div class="file-input-wrapper">
                    <input type="file" id="upload-file" accept="image/*" multiple required>
                    <span class="file-input-label"><i class="fas fa-file-image"></i> 选择文件</span>
                </div>
                <div id="file-name" class="file-name"></div>
            </div>
            
            <button type="submit" class="btn btn-primary">上传图片</button>
        </form>
        
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        
        <div id="upload-status" class="status-message"></div>
    </div>
</div>

<div class="dashboard-container" style="margin-top: 20px;">
    <!-- 系统信息 -->
    <div class="dashboard-card" style="grid-column: 1 / -1;">
        <h3 class="dashboard-title"><i class="fas fa-info-circle"></i> 系统信息</h3>
        <div class="system-info">
            <p>欢迎使用壁纸浏览网站管理面板！</p>
            <p>在此面板中，您可以：</p>
            <ul>
                <li>添加新的图片分类</li>
                <li>扫描现有文件夹以导入图片</li>
                <li>上传新的图片到指定分类</li>
                <li>删除不需要的分类（默认分类除外）</li>
            </ul>
            <p>注意事项：</p>
            <ul>
                <li>添加分类时，请确保文件夹路径有效</li>
                <li>上传图片时，请确保文件格式为支持的图片格式（PNG, JPG, JPEG, GIF, BMP）</li>
                <li>删除分类将不会删除实际的文件，但会从数据库中移除相关记录</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 添加分类表单提交
        const addCategoryForm = document.getElementById('add-category-form');
        const categoryStatus = document.getElementById('category-status');
        
        addCategoryForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // 详细日志记录
            console.log('开始处理添加分类请求');
            console.log('表单元素:', addCategoryForm);
            console.log('状态元素:', categoryStatus);
            
            const name = document.getElementById('category-name').value;
            const folderPath = document.getElementById('category-path').value;
            
            console.log('分类名称:', name);
            console.log('文件夹路径:', folderPath);
            console.log('Axios版本:', axios ? '已加载' : '未加载');
            
            // 显示加载状态
            categoryStatus.textContent = '处理中...';
            categoryStatus.className = 'status-message';
            categoryStatus.style.display = 'block';
            
            // 记录请求开始时间
            const startTime = new Date().getTime();
            
            try {
                axios.post('/admin/add_category', {
                    name: name,
                    folder_path: folderPath
                })
                .then(response => {
                    const endTime = new Date().getTime();
                    console.log('请求完成，耗时:', endTime - startTime, 'ms');
                    console.log('响应状态码:', response.status);
                    console.log('响应数据:', response.data);
                    
                    if (response.data.success) {
                        categoryStatus.textContent = response.data.message;
                        categoryStatus.classList.add('status-success');
                        categoryStatus.classList.remove('status-error');
                        categoryStatus.style.display = 'block';
                        
                        // 清空表单
                        addCategoryForm.reset();
                        
                        // 刷新页面
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        categoryStatus.textContent = response.data.message;
                        categoryStatus.classList.add('status-error');
                        categoryStatus.classList.remove('status-success');
                        categoryStatus.style.display = 'block';
                    }
                })
                .catch(error => {
                    const endTime = new Date().getTime();
                    console.log('请求失败，耗时:', endTime - startTime, 'ms');
                    console.error('添加分类失败:', error);
                    if (error.response) {
                        console.log('错误响应状态码:', error.response.status);
                        console.log('错误响应数据:', error.response.data);
                    } else if (error.request) {
                        console.log('无响应数据:', error.request);
                    } else {
                        console.log('请求配置错误:', error.message);
                    }
                    console.log('错误配置:', error.config);
                    
                    categoryStatus.textContent = '添加分类失败，请重试';
                    categoryStatus.classList.add('status-error');
                    categoryStatus.classList.remove('status-success');
                    categoryStatus.style.display = 'block';
                });
            } catch (e) {
                console.error('捕获到异常:', e);
                categoryStatus.textContent = '添加分类发生异常，请重试';
                categoryStatus.classList.add('status-error');
                categoryStatus.style.display = 'block';
            }
        });
        
        // 删除分类按钮
        const deleteButtons = document.querySelectorAll('.delete-btn');
        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const categoryId = this.getAttribute('data-id');
                const categoryName = this.getAttribute('data-name');
                
                if (confirm(`确定要删除分类 "${categoryName}" 吗？`)) {
                    axios.post(`/admin/delete_category/${categoryId}`)
                    .then(response => {
                        if (response.data.success) {
                            alert(response.data.message);
                            window.location.reload();
                        } else {
                            alert(response.data.message);
                        }
                    })
                    .catch(error => {
                        console.error('删除分类失败:', error);
                        alert('删除分类失败，请重试');
                    });
                }
            });
        });
        
        // 扫描文件夹按钮
        const scanButtons = document.querySelectorAll('.scan-btn');
        scanButtons.forEach(button => {
            button.addEventListener('click', function() {
                const categoryId = this.getAttribute('data-id');
                
                // 显示加载状态
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 扫描中...';
                this.disabled = true;
                
                axios.post(`/admin/scan_folder/${categoryId}`)
                .then(response => {
                    if (response.data.success) {
                        alert(response.data.message);
                    } else {
                        alert(response.data.message);
                    }
                })
                .catch(error => {
                    console.error('扫描文件夹失败:', error);
                    alert('扫描文件夹失败，请重试');
                })
                .finally(() => {
                    // 恢复按钮状态
                    this.innerHTML = '扫描文件夹';
                    this.disabled = false;
                });
            });
        });
        
        // 图片上传表单
        const uploadForm = document.getElementById('upload-form');
        const uploadFile = document.getElementById('upload-file');
        const fileName = document.getElementById('file-name');
        const progressContainer = document.querySelector('.progress-container');
        const progressBar = document.getElementById('progress-bar');
        const uploadStatus = document.getElementById('upload-status');
        
        // 显示选择的文件名
        uploadFile.addEventListener('change', function() {
            if (this.files.length > 0) {
                if (this.files.length === 1) {
                    fileName.textContent = this.files[0].name;
                } else {
                    fileName.textContent = `已选择 ${this.files.length} 个文件`;
                }
            } else {
                fileName.textContent = '';
            }
        });
        
        // 上传表单提交
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const categoryId = document.getElementById('upload-category').value;
            const files = uploadFile.files;
            
            if (files.length === 0) {
                alert('请选择要上传的图片');
                return;
            }
            
            // 显示进度条
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            
            // 逐个上传文件
            let uploadedCount = 0;
            const totalFiles = files.length;
            
            for (let i = 0; i < totalFiles; i++) {
                const file = files[i];
                const formData = new FormData();
                formData.append('file', file);
                formData.append('category_id', categoryId);
                
                axios.post('/admin/upload', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    },
                    onUploadProgress: function(progressEvent) {
                        if (progressEvent.total) {
                            const progress = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                            // 更新整体进度
                            const overallProgress = Math.round(((uploadedCount * 100) + progress) / totalFiles);
                            progressBar.style.width = `${overallProgress}%`;
                        }
                    }
                })
                .then(response => {
                    uploadedCount++;
                    
                    // 如果所有文件都上传完成
                    if (uploadedCount === totalFiles) {
                        uploadStatus.textContent = '所有图片上传成功';
                        uploadStatus.classList.add('status-success');
                        uploadStatus.classList.remove('status-error');
                        uploadStatus.style.display = 'block';
                        
                        // 重置表单
                        uploadForm.reset();
                        fileName.textContent = '';
                        
                        // 隐藏进度条
                        setTimeout(() => {
                            progressContainer.style.display = 'none';
                            uploadStatus.style.display = 'none';
                        }, 3000);
                    }
                })
                .catch(error => {
                    console.error('上传图片失败:', error);
                    uploadStatus.textContent = `上传第 ${i + 1} 个文件失败`;
                    uploadStatus.classList.add('status-error');
                    uploadStatus.classList.remove('status-success');
                    uploadStatus.style.display = 'block';
                    
                    // 增加上传计数，以便其他文件可以继续上传
                    uploadedCount++;
                    
                    // 如果所有文件都处理完毕
                    if (uploadedCount === totalFiles) {
                        // 隐藏进度条
                        setTimeout(() => {
                            progressContainer.style.display = 'none';
                            uploadStatus.style.display = 'none';
                        }, 3000);
                    }
                });
            }
        });
    });
</script>
{% endblock %}